<?xml version="1.0" encoding="UTF-8"?>
<entityConf xsi:noNamespaceSchemaLocation="../../entityconf.xsd"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" backend="com.ant.crawler.core.ListSubEntityCrawler">

	<entityFields>
		<rssSite>
		</rssSite>
		<listSite>
			<itemXpath>//div[@class='box_genre db']/ul[@class='genre_conter db']/li</itemXpath>
			<field xpath="span[@class='film_quality']/text()" name="filter_quality">
				<filter type="scriptone"><![CDATA[ if (!field.equals("HD")) field = null;]]></filter>
			</field>
			<field xpath="span[@class='film_note']/text()" name="tempWatch">
				<filter type="scriptone"><![CDATA[ 
					if (!field.startsWith("Tập ")) {
						field = null;
						return;
					}
					field = field.substring(4);
					var prog = field.split("/");
					if (prog.length == 2 && !prog[0].equals(prog[1])) {
						entity.setWatch(true);
					} 
				]]></filter>
			</field>
			<field xpath="div[@class='poster']/a/@href" name="tempSource">
				<filter type="scriptone">
					<![CDATA[
						var URL = Java.type("java.net.URL");
						var url = new URL(entity.getSourceUrl(), field);
						entity.setDetailUrl(url);
					]]>
				</filter>
			</field>
		</listSite>
		<detailSite>
			<field xpath="//div[@class='info-right f-right']/div[@class='poster']/img/@src" name="thumbnail">
				<filter type="scriptone">
					<![CDATA[
						var URL = Java.type("java.net.URL");
						var url = new URL(entity.getSourceUrl(), field);
						field= url.toString();
						var Date = Java.type("java.util.Date");
						entity.set("create_date", new Date());
						entity.set("owner_email", "tronglongcntt@gmail.com");
						entity.set("parrent", 1);
						entity.set("view", 10);
					]]>
				</filter>
			</field>
			<field xpath="//div[@class='info f-left']/h1/text()" name="title"></field>
			<field xpath="//div[@class='info f-left']/p[not(@*)]" name="description" required="false"></field>
			<field xpath="//div[@class='info-right f-right']/h3/p[strong/text() = 'Thể loại:']/a/text()" name="tags"  required="false">
				<filter type="regexall" replace=", ">\n</filter>
			</field>
		</detailSite>
		<subEntity link="//div[@class='info-right f-right']/span[@class='w-btn']/a[1]">
			<listSite>
				<itemXpath>//div[@class='server' and contains(div[@class='label'], 'Picasa')]/ul[@class='episodelist']/li/a</itemXpath>
				<field xpath="./text()" name="title">
					<filter type="scriptone">
					<![CDATA[
						entity.setSubID(field);
						if (field.length() == 1) field = "0" + field;
					]]></filter>
				</field>
				<field xpath="./@href" name="tempDetail">
					<filter type="scriptone">
						<![CDATA[
							var URL = Java.type("java.net.URL");
							var url = new URL(entity.getSourceUrl(), field);
							entity.setDetailUrl(url);
						]]>
					</filter>
				</field>
			</listSite>
			<detailSite>
				<field
				xpath="//div[@id='media']/script/text()" name="embed_web">
					<filter type="scriptone">
						<![CDATA[
							var proxyPrefix= "proxy.link\": \"";
							var index = field.indexOf(proxyPrefix);
							if (index == -1) {
								field = null;
								return;
							}
							index += proxyPrefix.length();
							var end = field.indexOf('"', index);
							field = field.substring(index, end);
							java.lang.System.out.println(field);
							var encoder = java.util.Base64.getUrlEncoder();
							var IOUtils = Java.type("org.apache.commons.io.IOUtils");
							var URL = Java.type("java.net.URL");
							try {
								var state = IOUtils.toString(new URL("http://phimdb.net/get_picasa/0/" + encoder.encodeToString(field.getBytes()).replace('_', '/')));
								if (state.length() < 10) {
									field = null;
								}
							} catch (e) {
								field = null;
							}
						]]>
					</filter>
				</field>
			</detailSite>
		</subEntity>
	</entityFields>
	<categories mappingField="category_id">
		<category id="1">
			http://9film.net/danh-sach/phim-bo/1
		</category>
	</categories>
</entityConf>